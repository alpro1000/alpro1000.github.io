<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TOV kalkul√°tor pro stavby (≈Ωeleznice & Mosty) ‚Äî v√Ωkaz v√Ωmƒõr, T-O-V, harmonogram</title>
<meta name="description" content="Automatick√Ω rozklad T-O-V podle v√Ωkazu v√Ωmƒõr / soupisu prac√≠. ≈Ωeleznice, mosty a p≈ôilehl√© objekty. √öRS / firemn√≠ normy, v√Ωpoƒçet bednƒõn√≠ (PERI/Doka/bƒõ≈æn√©), harmonogram (Gantt).">
<style>
  :root{
    --bg:#0c1116; --card:#121821; --ink:#e7edf3; --muted:#a9b3c9; --brand:#255cff;
    --ok:#27c498; --warn:#ffb020; --bad:#ff5470; --line:#1b2430;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial}
  a{color:var(--brand);text-decoration:none}
  header{padding:22px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(12,17,22,.8);backdrop-filter: blur(6px);z-index:3}
  .wrap{max-width:1060px;margin:0 auto;padding:0 18px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,#2c61ff, #7aa2ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
  nav{display:flex;gap:14px;flex-wrap:wrap}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#1f2a3a;color:#d7e2f0}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:#d7e2f0}
  .hero{padding:32px 0 10px}
  .h1{font-size:28px;line-height:1.2;margin:8px 0 6px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:16px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  h2{font-size:20px;margin:0 0 8px}
  h3{font-size:18px;margin:0 0 8px}
  .list{margin:0;padding-left:18px}
  .list li{margin:6px 0}
  .section{padding:18px 0 6px}
  .cta{display:flex;gap:10px;flex-wrap:wrap}
  .footer{padding:24px 0 60px;color:var(--muted);border-top:1px solid var(--line);margin-top:24px}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  input,select,textarea{background:#0e141c;color:#e7edf3;border:1px solid #1a2330;border-radius:10px;padding:10px 12px;width:100%}
  textarea{min-height:100px;resize:vertical}
  .mini{font-size:12px;line-height:1.3}
  .dropzone{border:2px dashed #2a3648;padding:16px;border-radius:12px;text-align:center;color:#b9c6db}
  .dropzone.drag{border-color:var(--brand);background:rgba(37,92,255,.06)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0e141c;border:1px solid #1a2330; padding:1px 6px;border-radius:6px}
  /* modals */
  .modal{display:none;position:fixed;inset:0;background:rgba(4,7,10,.6);backdrop-filter:blur(8px);z-index:99;align-items:center;justify-content:center;padding:18px}
  .modal-card{width:min(920px,100%);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .two{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  .g{display:grid;gap:12px}
  .tbl{width:100%;border-collapse:collapse;font-size:14px}
  .tbl th,.tbl td{border-bottom:1px solid #1a2330;padding:8px 6px;text-align:left}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#132033;border:1px solid #1f2c42;color:#c8d7ee;font-size:12px}
  /* floating CTA */
  #fab-chat{
    position: fixed; right: 18px; bottom: 18px;
    padding: 14px 18px; font-weight: 800; border: 0; border-radius: 999px;
    background: var(--brand); color: #fff; box-shadow: 0 12px 32px rgba(0,0,0,.35);
    cursor: pointer; z-index: 9999; letter-spacing:.2px
  }
  #fab-chat::after{
    content:""; position:absolute; inset:-8px; border-radius:999px;
    border:2px solid rgba(37,92,255,.35); animation:pulse 2.2s ease-out infinite;
  }
  @keyframes pulse{0%{opacity:1; transform:scale(.9)} 100%{opacity:0; transform:scale(1.25)}}
  @media (max-width:980px){ .cols-3{grid-template-columns:1fr} .cols-2{grid-template-columns:1fr} .two{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div class="wrap header-row">
    <div class="brand">
      <div class="logo">T</div>
      <div>TOV kalkul√°tor ‚Ä¢ ≈Ωeleznice & Mosty</div>
    </div>
    <nav>
      <button class="btn ghost" id="nav-services">Slu≈æby</button>
      <button class="btn secondary" id="open-intake">Nahr√°t podklady</button>
      <button class="btn secondary" id="open-harmo">Harmonogram</button>
      <button class="btn" id="open-pro">PRO p≈ô√≠stup</button>
      <button class="btn ghost" id="open-admin">Admin</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <div class="grid cols-2">
      <div class="card">
        <div class="badge">V√Ωkaz v√Ωmƒõr / Soupis prac√≠ ‚Üí T-O-V</div>
        <h1 class="h1">Automatick√Ω rozklad T-O-V a v√Ωpoƒçet bednƒõn√≠</h1>
        <p class="muted">
          √öRS / firemn√≠ normy, stroje a materi√°ly. ≈Ωeleznice, mosty a p≈ôilehl√© stavby.
          Import PDF/DOCX/XLSX/ZIP nebo z URL. N√°vrh harmonogramu (Gantt).
        </p>
        <div class="cta">
          <button class="btn" id="cta-start">Zah√°jit kalkulaci</button>
          <button class="btn secondary" id="cta-intake">Nahr√°t podklady</button>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Slu≈æby (co dostanete)</h3>
          <ul class="list">
            <li>Anal√Ωza <b>v√Ωkazu v√Ωmƒõr / soupisu prac√≠</b> a p≈ôevod do polo≈æek OTSKP.</li>
            <li>Automatick√Ω v√Ωbƒõr <b>T-O-V</b> (pr√°ce, stroje, materi√°l) ‚Äî <i>√öRS</i> nebo <i>firemn√≠ normy</i>.</li>
            <li><b>Bednƒõn√≠</b> (PERI/Doka/bƒõ≈æn√©): v√Ωmƒõra, stahov√°ky, podpƒõry, pron√°jem/amortizace.</li>
            <li><b>Harmonogram</b>: od mno≈æstv√≠ a produktivit k p≈ôedbƒõ≈æn√©mu Ganttu.</li>
            <li>Export <b>XLSX/CSV/JSON</b> pro KROS/√öRS a revizi.</li>
          </ul>
        </div>
        <div class="card">
          <h3>Freemium ‚Üí PRO</h3>
          <ul class="list">
            <li><b>Free:</b> 1‚Äì2 polo≈æky, bez bednƒõn√≠ a exportu.</li>
            <li><b>PRO:</b> pln√Ω T-O-V, bednƒõn√≠, exporty, import ZIP/URL.</li>
            <li><b>Expert:</b> firemn√≠ profily, historie, ≈°ablony.</li>
          </ul>
          <div class="mini muted">PRO data se naƒç√≠taj√≠ po ovƒõ≈ôen√≠ tokenu (n8n/Stripe).</div>
        </div>
      </div>
    </div>
  </section>

  <section class="section grid cols-3" id="services">
    <div class="card">
      <h2>Rozklad T-O-V</h2>
      <p class="muted">Podle OTSKP/√öRS a va≈°ich norem. Stroje (nap≈ô. dvoucestn√Ω bagr), materi√°ly, hodinov√© sazby.</p>
    </div>
    <div class="card">
      <h2>Bednƒõn√≠ PERI/Doka</h2>
      <p class="muted">Stƒõny, desky, tr√°my, sloupy. Plocha, stahov√°ky, podpƒõry, pron√°jem/amortizace, ƒçi≈°tƒõn√≠/olej.</p>
    </div>
    <div class="card">
      <h2>Harmonogram (Gantt)</h2>
      <p class="muted">D√©lky z mno≈æstv√≠ a produktivit. V√Ωluky, kalend√°≈ôe, kritick√° cesta. Export do XLSX/CSV.</p>
    </div>
  </section>

  <section class="section">
    <div class="card">
      <h2>Nahr√°t podklady k projektu</h2>
      <div class="grid cols-2">
        <div>
          <div id="dz" class="dropzone">P≈ôet√°hnƒõte sem PDF/DOCX/XLSX/CSV/ZIP‚Ä¶</div>
          <input id="file" type="file" multiple accept=".pdf,.doc,.docx,.xlsx,.csv,.zip" style="margin-top:8px">
          <div class="field">
            <label>nebo z URL</label>
            <input id="remote_url" placeholder="https://‚Ä¶ (Drive/SharePoint/S3)">
          </div>
          <div class="field">
            <label>N√°zev projektu</label>
            <input id="project_name" placeholder="N√°zev / stavba">
          </div>
          <button class="btn" id="send-intake">Odeslat k anal√Ωze</button>
          <div id="intake-status" class="mini muted" style="margin-top:6px"></div>
        </div>
        <div class="g">
          <div class="card">
            <h3>Jak to funguje</h3>
            <ol class="list">
              <li>Naƒçteme tabulky/text (OCR p≈ôi pot≈ôebƒõ) a sjednot√≠me do <span class="kbd">project.json</span>.</li>
              <li>Namapujeme na OTSKP (2025) a vybereme T-O-V (√öRS/Firm).</li>
              <li>Vyƒç√≠sl√≠me <b>bednƒõn√≠</b> a <b>harmonogram</b>.</li>
            </ol>
            <div class="mini muted">Zpracov√°n√≠ zaji≈°≈•uje n8n (va≈°e instance) + OpenAI p≈ôes n8n.</div>
          </div>
          <div class="card">
            <h3>Soukrom√≠</h3>
            <p class="mini muted">Soubor(y) jsou ulo≈æeny priv√°tnƒõ (S3/Drive), po 30‚Äì90 dnech lze auto-mazat.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="footer">
    <div class="grid cols-2">
      <div>
        <div class="muted">¬© <span id="y"></span> TOV kalkul√°tor. ≈Ωeleznice & mosty.</div>
      </div>
      <div class="muted" style="text-align:right">Kontakt: <span id="contact-mail">alpro1000@gmail.com</span></div>
    </div>
  </section>
</main>

<!-- Floating chat button -->
<button id="fab-chat" aria-label="Otev≈ô√≠t T-O-V bota">üí¨ Chat bot</button>

<!-- BOT MODAL -->
<div class="modal" id="bot-modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h3 style="margin:0">T-O-V bot</h3>
      <button class="btn secondary" id="bot-close">Zav≈ô√≠t</button>
    </div>

    <div class="two" style="margin-top:10px">
      <div class="g">
        <div class="card">
          <div class="grid cols-2">
            <div class="field">
              <label>Profil norem</label>
              <select id="norm-profile">
                <option value="REFERENCE">√öRS (reference)</option>
                <option value="FIRM">Firemn√≠ normy</option>
              </select>
            </div>
            <div class="field">
              <label>OTSKP / n√°zev polo≈æky</label>
              <input id="boq-code" placeholder="nap≈ô. 52Z123 nebo text polo≈æky">
            </div>
          </div>
          <div class="field">
            <label>Kontext (kr√°tce):</label>
            <textarea id="boq-note" placeholder="geometrie, p≈ô√≠stup, v√Ωluka, stroj (dvoucestn√Ω bagr)‚Ä¶"></textarea>
          </div>
          <div class="grid cols-2">
            <div class="field">
              <label>Mno≈æstv√≠</label>
              <input id="boq-qty" type="number" placeholder="nap≈ô. 300">
            </div>
            <div class="field">
              <label>MJ</label>
              <input id="boq-unit" placeholder="m, m2, m3, ks‚Ä¶">
            </div>
          </div>
          <button class="btn" id="tov-run">Navrhnout T-O-V</button>
          <div id="tov-status" class="mini muted" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <h3>V√Ωpoƒçet bednƒõn√≠ (voliteln√©)</h3>
          <div class="grid cols-2">
            <div class="field"><label>Prvek</label>
              <select id="form-type">
                <option value="stena">Stƒõna / opƒõra</option>
                <option value="deska">Deska</option>
                <option value="tram">Tr√°m</option>
                <option value="sloup">Sloup</option>
              </select>
            </div>
            <div class="field"><label>Typ bednƒõn√≠</label>
              <select id="form-system">
                <option value="systemove">Syst√©mov√© (PERI/Doka)</option>
                <option value="bezne">Bƒõ≈æn√©</option>
              </select>
            </div>
          </div>
          <div class="grid cols-2">
            <div class="field"><label>V√Ω≈°ka H [m]</label><input id="geo-h" type="number" step="0.01"></div>
            <div class="field"><label>Tlou≈°≈•ka/≈†√≠≈ôka t/b [m]</label><input id="geo-t" type="number" step="0.01"></div>
          </div>
          <div class="grid cols-2">
            <div class="field"><label>D√©lka [m]</label><input id="geo-L" type="number" step="0.01"></div>
            <div class="field"><label>Otvorov√° plocha [m¬≤]</label><input id="geo-open" type="number" step="0.01" value="0"></div>
          </div>
          <button class="btn secondary" id="form-calc">Spoƒç√≠tat m¬≤ a n√°klady</button>
          <div id="form-out" class="mini muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="card">
        <h3>N√°vrh T-O-V</h3>
        <table class="tbl" id="tov-table">
          <thead><tr><th>Typ</th><th>N√°zev</th><th>MJ</th><th>Qty</th><th>Sazba/Kƒç</th><th>Subtot√°l</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="tov-total" style="margin-top:8px"></div>
        <div class="mini muted" id="tov-flags" style="margin-top:6px"></div>
        <div class="cta" style="margin-top:10px">
          <button class="btn secondary" id="export-xlsx">Export XLSX</button>
          <button class="btn ghost" id="export-json">Export JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRO MODAL -->
<div class="modal" id="pro-modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">PRO p≈ô√≠stup</h3>
      <button class="btn secondary" id="pro-close">Zav≈ô√≠t</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="grid cols-2">
        <div class="field"><label>E-mail</label><input id="pro-email" placeholder="vas@firma.cz"></div>
        <div class="field"><label>Token</label><input id="pro-token" placeholder="vlo≈æit token"></div>
      </div>
      <div class="field"><label>Co naƒç√≠st</label>
        <select id="pro-what">
          <option value="all">V≈°e (doporuƒçeno)</option>
          <option value="rules">TOV pravidla</option>
          <option value="rates">Sazby</option>
          <option value="tkp">TKP pravidla</option>
        </select>
      </div>
      <button class="btn" id="pro-validate">Aktivovat PRO</button>
      <div id="pro-status" class="mini muted" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="modal" id="admin-modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Admin</h3>
      <button class="btn secondary" id="admin-close">Zav≈ô√≠t</button>
    </div>
    <div class="grid cols-2" style="margin-top:10px">
      <div class="card">
        <h3>Import pravidel (JSON)</h3>
        <div class="field"><input id="json-file" type="file" accept=".json"></div>
        <button class="btn" id="import-json">Importovat do prohl√≠≈æeƒçe</button>
        <div class="mini muted" id="admin-status" style="margin-top:6px"></div>
      </div>
      <div class="card">
        <h3>Profily sazeb</h3>
        <div class="field"><label>Mzda [Kƒç/h]</label><input id="rate-labor" type="number" value="366"></div>
        <div class="field"><label>N√°klady stroj≈Ø (p≈ô√≠klad)</label><textarea id="rate-machines" placeholder='[{"name":"Dvoucestn√Ω bagr","rate":2600}]'></textarea></div>
        <button class="btn secondary" id="save-rates">Ulo≈æit</button>
      </div>
    </div>
  </div>
</div>

<!-- HARMONOGRAM MODAL -->
<div class="modal" id="harmo-modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Harmonogram (n√°ƒçrt Gantt)</h3>
      <button class="btn secondary" id="harmo-close">Zav≈ô√≠t</button>
    </div>
    <div class="two" style="margin-top:10px">
      <div class="card">
        <h3>√ökoly z T-O-V</h3>
        <div class="mini muted">Zadejte produktivity; d√©lky se spoƒç√≠taj√≠ z mno≈æstv√≠.</div>
        <table class="tbl" id="harmo-tbl">
          <thead><tr><th>√ökol</th><th>MJ</th><th>Qty</th><th>Prod/den</th><th>Dn√≠</th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn" id="harmo-recalc">P≈ôepoƒç√≠tat</button>
      </div>
      <div class="card">
        <h3>Gantt (n√°hled)</h3>
        <canvas id="gantt" width="800" height="320" style="max-width:100%;background:#0e141c;border:1px solid #1b2430;border-radius:8px"></canvas>
        <div class="cta" style="margin-top:10px">
          <button class="btn secondary" id="harmo-export">Export CSV</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- INTAKE MODAL (quick access) -->
<div class="modal" id="intake-modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Nahr√°t podklady</h3>
      <button class="btn secondary" id="intake-close">Zav≈ô√≠t</button>
    </div>
    <div class="card" style="margin-top:10px">
      <div id="dz2" class="dropzone">P≈ôet√°hnƒõte sem PDF/DOCX/XLSX/CSV/ZIP‚Ä¶</div>
      <input id="file2" type="file" multiple accept=".pdf,.doc,.docx,.xlsx,.csv,.zip" style="margin-top:8px">
      <div class="field"><label>nebo z URL</label><input id="remote_url2" placeholder="https://‚Ä¶"></div>
      <div class="field"><label>N√°zev projektu</label><input id="project_name2" placeholder="N√°zev / stavba"></div>
      <button class="btn" id="send-intake2">Odeslat k anal√Ωze</button>
      <div id="intake-status2" class="mini muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   KONFIGURACE ENDPOINT≈Æ
   ========================= */
const N8N_VALIDATE_URL = 'https://YOUR_N8N_HOST/webhook/validate-pro'; // ovƒõ≈ôen√≠ PRO a naƒçten√≠ pravidel
const N8N_INTAKE_URL   = 'https://YOUR_N8N_HOST/webhook/intake';       // p≈ô√≠jem soubor≈Ø/URL ‚Üí project.json
const N8N_STATUS_URL   = 'https://YOUR_N8N_HOST/webhook/status';       // stav zpracov√°n√≠ job_id
const N8N_TOV_URL      = 'https://YOUR_N8N_HOST/webhook/tov';          // LLM rozklad T-O-V + ceny
// Pozn√°mka: v n8n napoj√≠≈° OpenAI a √∫lo≈æi≈°tƒõ (S3/Drive). Frontend nepos√≠l√° API kl√≠ƒçe, v≈°e p≈ôes n8n.

/* =========================
   POMOCN√â FUNKCE
   ========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function toast(el, msg){ el.textContent = msg; }
function money(x){ return isFinite(x) ? (Math.round(x*100)/100).toLocaleString('cs-CZ')+' Kƒç' : '‚Äì' }
function days(x){ return isFinite(x) ? (Math.ceil(x*10)/10)+' d' : '‚Äì' }
function dl(el){ const a=document.createElement('a'); a.href=el; a.download='export.json'; a.click(); }

function toCSV(rows){
  return rows.map(r=>r.map(v=>('"'+String(v).replaceAll('"','""')+'"')).join(',')).join('\n');
}

// LocalStorage kl√≠ƒçe
const LS = {
  TOV_URS: 'tov_rules_urs',
  TOV_EXP: 'tov_rules_expert',
  RATES:   'rates_catalog',
  TKP:     'tkp_rules',
  COEFS:   'coef_2019',
  LAST:    'last_project',
  HARM:    'harmo_tasks'
};

// Demo defaulty (m≈Ø≈æe≈° smazat po PRO aktivaci)
if(!localStorage.getItem(LS.RATES)){
  const demoRates = {"labor":366, "machines":[{"name":"Dvoucestn√Ω bagr","rate":2600},{"name":"Autoje≈ô√°b 25 t","rate":1800}]};
  localStorage.setItem(LS.RATES, JSON.stringify(demoRates));
}

/* =========================
   H E A D E R  /  CTA
   ========================= */
$('#cta-start').onclick = ()=> $('#bot-modal').style.display='flex';
$('#open-intake').onclick = ()=> $('#intake-modal').style.display='flex';
$('#cta-intake').onclick = ()=> $('#intake-modal').style.display='flex';
$('#open-pro').onclick = ()=> $('#pro-modal').style.display='flex';
$('#open-admin').onclick = ()=> $('#admin-modal').style.display='flex';
$('#open-harmo').onclick = ()=> {$ ('#harmo-modal').style.display='flex'; renderHarmoFromTOV();}
$('#nav-services').onclick = ()=> window.scrollTo({top: $('#services').offsetTop-60, behavior:'smooth'});

/* =========================
   F L O A T I N G   B O T
   ========================= */
$('#fab-chat').onclick = ()=> $('#bot-modal').style.display='flex';
$('#bot-close').onclick = ()=> $('#bot-modal').style.display='none';

/* =========================
   P R O  A K T I V A C E
   ========================= */
$('#pro-close').onclick = ()=> $('#pro-modal').style.display='none';
$('#pro-validate').onclick = async ()=>{
  const email = $('#pro-email').value.trim();
  const token = $('#pro-token').value.trim();
  const what  = $('#pro-what').value;
  const out   = $('#pro-status');
  if(!email || !token){ return toast(out,'Vypl≈àte e-mail i token.'); }
  toast(out,'Ovƒõ≈ôuji‚Ä¶');
  try{
    const r = await fetch(N8N_VALIDATE_URL,{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, token, want: what, userAgent: navigator.userAgent})});
    if(!r.ok){ return toast(out,'Chyba p≈ôipojen√≠ / 403'); }
    const data = await r.json();
    if(!data.allowed){ return toast(out, data.message||'P≈ô√≠stup zam√≠tnut.'); }
    if(data.pro?.rules_urs){ localStorage.setItem(LS.TOV_URS, JSON.stringify(data.pro.rules_urs)); }
    if(data.pro?.rules_expert){ localStorage.setItem(LS.TOV_EXP, JSON.stringify(data.pro.rules_expert)); }
    if(data.pro?.rates){ localStorage.setItem(LS.RATES, JSON.stringify(data.pro.rates)); }
    if(data.pro?.tkp){ localStorage.setItem(LS.TKP, JSON.stringify(data.pro.tkp)); }
    if(data.pro?.coefs){ localStorage.setItem(LS.COEFS, JSON.stringify(data.pro.coefs)); }
    toast(out,'PRO aktivov√°no. Datov√© sady nahr√°ny.');
  }catch(e){ toast(out,'V√Ωpadek nebo neplatn√° odpovƒõƒè.'); }
};

/* =========================
   A D M I N
   ========================= */
$('#admin-close').onclick = ()=> $('#admin-modal').style.display='none';
$('#import-json').onclick = async ()=>{
  const f = $('#json-file').files?.[0];
  if(!f) return toast($('#admin-status'),'Vyberte JSON soubor.');
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    // heuristika: ulo≈æ pod dle top-level kl√≠ƒç≈Ø
    if(obj.rules) localStorage.setItem(LS.TKP, JSON.stringify(obj));
    else if(obj.rates || obj.machines) localStorage.setItem(LS.RATES, JSON.stringify(obj));
    else if(Array.isArray(obj)) localStorage.setItem(LS.TOV_URS, JSON.stringify(obj));
    toast($('#admin-status'),'Naƒçteno. Data jsou v prohl√≠≈æeƒçi.');
  }catch(e){ toast($('#admin-status'),'Chybn√Ω JSON.'); }
};
$('#save-rates').onclick = ()=>{
  const labor = parseFloat($('#rate-labor').value||'366');
  let machines = []; try{ machines = JSON.parse($('#rate-machines').value||'[]'); }catch(e){}
  localStorage.setItem(LS.RATES, JSON.stringify({labor, machines}));
  alert('Sazby ulo≈æeny.');
};

/* =========================
   I N T A K E  (files/URL/ZIP)
   ========================= */
function wireDropzone(boxId, inputId){
  const dz = $(boxId), fi=$(inputId);
  dz.ondragover = e=>{ e.preventDefault(); dz.classList.add('drag'); };
  dz.ondragleave= ()=> dz.classList.remove('drag');
  dz.ondrop = e=>{ e.preventDefault(); dz.classList.remove('drag'); fi.files = e.dataTransfer.files; };
}
wireDropzone('#dz','#file'); wireDropzone('#dz2','#file2');

async function sendIntake(fileInputId, urlInputId, nameInputId, outId){
  const files = $(fileInputId).files; const url = $(urlInputId).value.trim(); const name = $(nameInputId).value.trim()||'Ad hoc';
  const fd = new FormData();
  if(url) fd.append('remote_url', url);
  Array.from(files).forEach(f=>fd.append('files', f));
  fd.append('project_name', name);
  toast($(outId),'Nahr√°v√°m‚Ä¶');
  try{
    const r = await fetch(N8N_INTAKE_URL, {method:'POST', body:fd});
    if(!r.ok) return toast($(outId),'Chyba p≈ôi odesl√°n√≠.');
    const data = await r.json();
    if(data.job_id){ localStorage.setItem(LS.LAST, data.job_id); toast($(outId), 'P≈ôijato (job '+data.job_id+'). Zpracov√°v√°m‚Ä¶'); }
    else toast($(outId), data.message || 'P≈ôijato.');
  }catch(e){ toast($(outId),'S√≠≈•ov√° chyba.'); }
}
$('#send-intake').onclick = ()=> sendIntake('#file','#remote_url','#project_name','#intake-status');
$('#send-intake2').onclick= ()=> sendIntake('#file2','#remote_url2','#project_name2','#intake-status2');
$('#intake-close').onclick = ()=> $('#intake-modal').style.display='none';

/* =========================
   T-O-V  B O T
   ========================= */
$('#tov-run').onclick = async ()=>{
  const profile = $('#norm-profile').value;
  const code = $('#boq-code').value.trim();
  const note = $('#boq-note').value.trim();
  const qty  = parseFloat($('#boq-qty').value||'0');
  const unit = $('#boq-unit').value.trim();
  const out  = $('#tov-status');
  if(!code) return toast(out,'Zadejte OTSKP nebo n√°zev polo≈æky.');
  toast(out,'Poƒç√≠t√°m‚Ä¶');
  try{
    // vol√°n√≠ na n8n: ten zavol√° LLM a vr√°t√≠ strukturovan√Ω n√°vrh T/O/V
    const r = await fetch(N8N_TOV_URL,{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({profile, code, note, qty, unit})});
    if(!r.ok) return toast(out,'Chyba zpracov√°n√≠.');
    const data = await r.json(); // oƒçek√°v√°me {items:[{type:'T'|'O'|'V', name, unit, qty, rate, subtotal}], flags:[], totals:{...}}
    renderTOV(data, qty, unit);
    // naplnit harmonogram tab
    seedHarmoFromTOV(data, qty, unit);
    toast(out,'Hotovo.');
  }catch(e){ toast(out,'S√≠≈•ov√° chyba.'); }
};

function renderTOV(data, baseQty, unit){
  const tb = $('#tov-table tbody'); tb.innerHTML='';
  let total = 0;
  (data.items||[]).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.type||''}</td><td>${x.name||''}</td><td>${x.unit||''}</td><td>${x.qty??''}</td><td>${money(x.rate||0)}</td><td>${money(x.subtotal||0)}</td>`;
    tb.appendChild(tr);
    total += (+x.subtotal||0);
  });
  $('#tov-total').innerHTML = `<b>Celkem:</b> ${money(total)} <span class="muted">(${baseQty||''} ${unit||''})</span>`;
  $('#tov-flags').textContent = (data.flags && data.flags.length)? ('Pozn√°mky: '+data.flags.join(' | ')) : '';
}

/* =========================
   B E D N ƒö N √ç  (lok√°ln√≠ v√Ωpoƒçet)
   ========================= */
$('#form-calc').onclick = ()=>{
  const typ = $('#form-type').value, sys = $('#form-system').value;
  const H = parseFloat($('#geo-h').value||'0'), t = parseFloat($('#geo-t').value||'0');
  const L = parseFloat($('#geo-L').value||'0'), open = parseFloat($('#geo-open').value||'0');
  // plocha
  let A=0;
  if(typ==='stena') A = Math.max(0, (L*H) - open);
  if(typ==='deska') A = Math.max(0, (L*t) - open); // zjednodu≈°enƒõ: L=obvod, t=tlou≈°≈•ka hrany; soffit by ≈°el z p≈Ødorysu (nen√≠-li)
  if(typ==='tram')  A = Math.max(0, (2*H + 2*t)*L - open);
  if(typ==='sloup') A = Math.max(0, Math.PI*t*H - open); // t zde ~ pr≈Ømƒõr
  const odpad = 0.05; const Aeff = A*(1+odpad);

  // parametry norem (zjednodu≈°en√© defaulty)
  const labor = (JSON.parse(localStorage.getItem(LS.RATES)||'{}').labor)||366;
  let m2h_mont = 6, m2h_dem = 8, rent = 90; // syst√©mov√© defaulty
  if(sys==='bezne'){ m2h_mont=4; m2h_dem=5; rent=0; } // bƒõ≈æn√©: ≈æ√°dn√Ω pron√°jem, ale v√≠c pr√°ce

  const T_h = (Aeff/m2h_mont) + (Aeff/m2h_dem) + 0.5;
  const T_kc= T_h*labor;
  const rent_kc = rent>0 ? (Aeff * rent * Math.ceil(3/7)) : 0; // p≈ôedpoklad 3 dny cyklu
  const O_kc = 0; // je≈ô√°b ponech√°me na n8n (nebo p≈ôid√°≈° parametr)
  const V_kc = (sys==='systemove') ? (Aeff*12) : (Aeff*8); // drobn√Ω materi√°l, olej atd. (z√°klad)

  const C = T_kc + rent_kc + O_kc + V_kc;
  $('#form-out').innerHTML = `Plocha ‚âà <b>${(Aeff).toFixed(2)} m¬≤</b> (vƒç. odpad 5 %). N√°klady: pr√°ce ${money(T_kc)}, pron√°jem ${money(rent_kc)}, materi√°l ${money(V_kc)} ‚áí <b>${money(C)}</b>.`;
};

/* =========================
   E X P O R T Y
   ========================= */
$('#export-json').onclick = ()=>{
  const rows = Array.from($('#tov-table tbody').rows).map(tr=>({
    type: tr.cells[0].textContent, name: tr.cells[1].textContent, unit: tr.cells[2].textContent,
    qty: tr.cells[3].textContent, rate: tr.cells[4].textContent, subtotal: tr.cells[5].textContent
  }));
  const blob = new Blob([JSON.stringify({items:rows}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tov.json'; a.click(); URL.revokeObjectURL(url);
};
$('#export-xlsx').onclick = ()=>{
  // jednoduch√Ω CSV m√≠sto XLSX (n8n m≈Ø≈æe p≈ôev√©st do XLSX serverovƒõ)
  const rows = [['Typ','N√°zev','MJ','Qty','SazbaKc','SubTotal']];
  Array.from($('#tov-table tbody').rows).forEach(tr=>rows.push(Array.from(tr.cells).map(td=>td.textContent)));
  const csv = toCSV(rows); const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tov.csv'; a.click(); URL.revokeObjectURL(url);
};

/* =========================
   H A R M O N O G R A M
   ========================= */
$('#harmo-close').onclick = ()=> $('#harmo-modal').style.display='none';
function seedHarmoFromTOV(data, baseQty, unit){
  // najdeme 1‚Äì3 hlavn√≠ polo≈æky a vlo≈æ√≠me do tabulky
  const tbl = $('#harmo-tbl tbody'); tbl.innerHTML='';
  const items = (data.items||[]).filter(x=>x.type==='T').slice(0,3);
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td contenteditable="true">${it.name||('√ökol '+(i+1))}</td>
      <td>${unit||it.unit||''}</td>
      <td>${baseQty||it.qty||''}</td>
      <td contenteditable="true">40</td>
      <td></td>`;
    tbl.appendChild(tr);
  });
  localStorage.setItem(LS.HARM, JSON.stringify(items));
}
function renderHarmoFromTOV(){
  const tbl = $('#harmo-tbl tbody');
  if(tbl.rows.length===0){
    const demo=[['V√Ωmƒõna ≈°tƒõrku','m3',300,40],['Beton√°≈æ opƒõry','m3',120,25]];
    demo.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td contenteditable="true">${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td><td contenteditable="true">${d[3]}</td><td></td>`;
      tbl.appendChild(tr);
    });
  }
  recalcHarmo();
}
function recalcHarmo(){
  const tbl = $('#harmo-tbl tbody');
  const tasks=[];
  for(const tr of tbl.rows){
    const name=tr.cells[0].textContent.trim();
    const unit=tr.cells[1].textContent.trim();
    const qty = parseFloat(tr.cells[2].textContent||'0');
    const prod= parseFloat(tr.cells[3].textContent||'0');
    const d = prod>0 ? (qty/prod) : 0;
    tr.cells[4].textContent = days(d);
    tasks.push({name, unit, qty, prod, d});
  }
  drawGantt(tasks);
}
$('#harmo-recalc').onclick = recalcHarmo;

function drawGantt(tasks){
  const c = $('#gantt'), g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height);
  const pad=14, row=26, x0=120, dayPix=30;
  g.fillStyle='#9fb0c8'; g.font='12px system-ui';
  g.fillText('Den ‚Üí', x0, 16);
  tasks.forEach((t,i)=>{
    const y= i*row + 40;
    g.fillStyle='#cfe0ff'; g.fillText(t.name, 8, y+12);
    const w = (t.d||0)*dayPix;
    g.fillStyle='#2c61ff'; g.fillRect(x0, y, Math.max(4,w), 14);
    g.fillStyle='#9fb0c8'; g.fillText((t.d? t.d.toFixed(1):'0')+' d', x0 + Math.max(4,w)+6, y+12);
  });
}

$('#harmo-export').onclick = ()=>{
  const tbl = $('#harmo-tbl tbody');
  const rows=[['Task','Unit','Qty','Prod/day','Days']];
  for(const tr of tbl.rows){
    rows.push([tr.cells[0].textContent.trim(), tr.cells[1].textContent.trim(), tr.cells[2].textContent.trim(), tr.cells[3].textContent.trim(), tr.cells[4].textContent.trim()]);
  }
  const csv = toCSV(rows); const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='harmonogram.csv'; a.click(); URL.revokeObjectURL(url);
};

/* =========================
   U T I L S
   ========================= */
document.getElementById('y').textContent = new Date().getFullYear();
</script>
</body>
</html>