<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TOV kalkul√°tor ‚Ä¢ Mosty & ≈Ωeleznice</title>
<meta name="description" content="Slu≈æby rozpoƒçtov√°n√≠ (√öRS/KROS), T-O-V anal√Ωza, bednƒõn√≠, harmonogram.">
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#1f2a36; --muted:#556270; --accent:#255cff;
    --line:#e8ebf3; --good:#17a673; --warn:#cc9a06; --bad:#d9534f;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1080px;margin:0 auto;padding:20px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:12px 0 8px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6ea8fe,#c1d3ff)}
  .title{font-weight:800;letter-spacing:.2px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:0;background:var(--accent);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e9eefc;color:#2440a6}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5ff}
  .btn.flat{background:#eef2f9;color:#233048}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 4px 20px rgba(10,20,60,.04)}
  h1{font-size:22px;margin:6px 0 10px}
  h2{font-size:18px;margin:0 0 8px}
  h3{font-size:16px;margin:0 0 8px}
  .muted{color:var(--muted)}
  .mini{font-size:12px;color:#6b7685}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  .field input,.field select,.field textarea{
    border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;color:#1d2733;outline:none
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpi{display:flex;gap:10px;align-items:center;background:#f1f5ff;border:1px dashed #cfd8ff;padding:10px 12px;border-radius:12px}
  .dropzone{border:2px dashed #b9c3d9;background:#fafbff;border-radius:12px;padding:16px;text-align:center;color:#4a5568}
  .dropzone.drag{border-color:var(--accent);background:rgba(37,92,255,.05)}
  .list{margin:8px 0 0;padding:0;list-style:none}
  .list li{padding:8px 0;border-bottom:1px solid var(--line)}
  .tag{display:inline-block;border-radius:999px;background:#eff3fb;border:1px solid #dfe6f5;padding:2px 8px;font-size:12px;margin-right:6px}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  footer{margin:20px 0 60px;color:#738091}

  /* FAB Chat button */
  #fab-chat{
    position: fixed; right: 18px; bottom: 18px;
    padding: 14px 18px; font-weight: 800; border: 0; border-radius: 999px;
    background: var(--accent); color: #fff; box-shadow: 0 12px 32px rgba(37,92,255,.35);
    cursor: pointer; z-index: 9999; letter-spacing:.2px;
  }
  #fab-chat::after{
    content:""; position:absolute; inset:-8px; border-radius:999px;
    border:2px solid rgba(37,92,255,.35); animation:pulse 2.2s ease-out infinite;
  }
  @keyframes pulse{ 0%{opacity:1; transform:scale(.9)} 100%{opacity:0; transform:scale(1.25)} }

  /* Modals */
  .modal{display:none;position:fixed;inset:0;background:rgba(5,12,30,.4);backdrop-filter:blur(2px);z-index:10000;align-items:center;justify-content:center;padding:14px}
  .modal-card{width:min(880px,96vw);background:#fff;border-radius:16px;border:1px solid var(--line);padding:16px;max-height:88vh;overflow:auto}
  .stack{display:flex;gap:10px;flex-direction:column}
  .chat{height:320px;border:1px solid var(--line);border-radius:12px;padding:10px;overflow:auto;background:#fafcff}
  .msg{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:82%}
  .me{background:#e9eefc;margin-left:auto} .ai{background:#f3f7ff}
  .divider{height:1px;background:var(--line);margin:8px 0}
</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Rozpoƒçty ‚Ä¢ Mosty & ≈Ωeleznice</div>
        <div class="mini muted">√öRS/KROS ‚Ä¢ T-O-V ‚Ä¢ Bednƒõn√≠ ‚Ä¢ Harmonogram</div>
      </div>
    </div>
    <nav>
      <button class="btn secondary" id="btn-pro">PRO</button>
      <button class="btn ghost" id="btn-admin">Admin</button>
    </nav>
  </header>

  <div class="grid">
    <!-- Left column -->
    <section class="card">
      <h1>Rychl√° kalkulace</h1>
      <div class="row">
        <span class="kpi">üî• <b>T-O-V bot</b> ‚Äì rozpad pr√°ce, stroje, materi√°ly</span>
        <span class="kpi">üß± Bednƒõn√≠ ‚Äì v√Ωpoƒçet plochy a n√°klad≈Ø</span>
        <span class="kpi">üìÖ Harmonogram ‚Äì n√°st≈ôel Gantt</span>
      </div>

      <div class="divider"></div>

      <h2>Vstup projektov√Ωch podklad≈Ø</h2>
      <div id="drop" class="dropzone">P≈ôet√°hnƒõte sem PDF/DOCX/XLSX/CSV/ZIP nebo pou≈æijte tlaƒç√≠tko n√≠≈æe.</div>
      <div class="row" style="margin-top:8px">
        <input id="file" type="file" multiple accept=".pdf,.docx,.xlsx,.csv,.zip">
        <input id="url" class="grow" style="flex:1" placeholder="nebo vlo≈æte URL (Drive/SharePoint/S3)">
        <button class="btn" id="send">Odeslat k anal√Ωze</button>
      </div>
      <div id="status" class="mini" style="margin-top:6px;color:#5f6f66"></div>

      <ul class="list" id="log"></ul>
    </section>

    <!-- Right column -->
    <aside class="card">
      <h2>Rychl√© akce</h2>
      <div class="row">
        <button class="btn flat" id="open-bot">Zah√°jit T-O-V</button>
        <button class="btn flat" id="open-formwork">Bednƒõn√≠</button>
        <button class="btn flat" id="open-gantt">Harmonogram</button>
      </div>
      <div class="divider"></div>
      <h3>Re≈æim norem</h3>
      <div class="row">
        <label class="tag"><input type="radio" name="norm" value="REFERENCE" checked> REFERENCE (√öRS)</label>
        <label class="tag"><input type="radio" name="norm" value="FIRM"> FIRM (moje)</label>
      </div>
      <div class="divider"></div>
      <h3>Stav</h3>
      <div class="mini">Datov√© sady: <span id="ds-status">Free</span></div>
      <div class="mini">Token: <span id="token-status">nezad√°n</span></div>
      <div class="mini">Posledn√≠ akce: <span id="last-action">‚Äî</span></div>
    </aside>
  </div>

  <footer>
    ¬© 2025 ‚Ä¢ Rozpoƒçty (√öRS/KROS) ‚Ä¢ Konzultace & kalkulace. Kontakt: <a href="mailto:alpro1000@gmail.com">alpro1000@gmail.com</a>
  </footer>
</div>

<!-- Floating Chat Button -->
<button id="fab-chat" aria-label="Otev≈ô√≠t T-O-V bota">üí¨ Chat bot</button>

<!-- MODAL: T-O-V BOT -->
<div class="modal" id="bot-modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">T-O-V bot</h3>
      <div class="row">
        <button class="btn flat" id="bot-harmonogram">Harmonogram</button>
        <button class="btn flat" id="bot-formwork">Bednƒõn√≠</button>
        <button class="btn secondary" id="bot-close">Zav≈ô√≠t</button>
      </div>
    </div>
    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 320px">
      <div class="stack">
        <div class="chat" id="chat">
          <div class="msg ai">Napi≈°te k√≥d OTSKP nebo n√°zev pr√°ce (v√Ωkaz v√Ωmƒõr / soupis prac√≠). Nap≈ô.: ‚ÄûV√Ωmƒõna ≈°tƒõrku 300 m¬≥‚Äú.</div>
        </div>
        <div class="row">
          <input id="chat-in" placeholder="Nap≈ô.: 200-xxx beton√°≈æ opƒõry 120 m¬≥, XC3, C30/37">
          <button class="btn" id="chat-send">Odeslat</button>
        </div>
      </div>
      <div class="stack">
        <div class="card" style="padding:12px">
          <div class="mini muted">V√Ωstup (n√°hled)</div>
          <ul id="preview" class="list"></ul>
        </div>
        <div class="row">
          <button class="btn ghost" id="export-json">Export JSON</button>
          <button class="btn ghost" id="export-xlsx">Export XLSX</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: PRO -->
<div class="modal" id="pro-modal" aria-modal="true" role="dialog">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">PRO p≈ô√≠stup</h3>
      <button class="btn secondary" id="pro-close">Zav≈ô√≠t</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="field"><label>E-mail</label><input id="pro-email" placeholder="vas@firma.cz"></div>
      <div class="field"><label>Token</label><input id="pro-token" placeholder="vlo≈æit token"></div>
      <div class="field"><label>Zdroj PRO dat</label>
        <select id="pro-what">
          <option value="all">V≈°e (doporuƒçeno)</option>
          <option value="rules">TOV pravidla (roz≈°√≠≈ôen√°)</option>
          <option value="rates">Sazby (mzda/stroje)</option>
          <option value="tkp">TKP pravidla (pln√°)</option>
        </select>
      </div>
      <button class="btn" id="pro-validate">Aktivovat PRO</button>
      <div id="pro-status" class="mini" style="margin-top:8px;color:#5f6f66"></div>
    </div>
  </div>
</div>

<!-- MODAL: ADMIN (import lok√°ln√≠ch JSON/Excel) -->
<div class="modal" id="admin-modal" aria-modal="true" role="dialog">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Admin ‚Ä¢ Datov√© sady</h3>
      <button class="btn secondary" id="admin-close">Zav≈ô√≠t</button>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <h3>Import JSON</h3>
        <div class="field"><input type="file" id="json-file" accept=".json"></div>
        <div class="row"><button class="btn" id="json-load">Naƒç√≠st</button><span class="mini" id="json-status"></span></div>
      </div>
      <div class="card">
        <h3>Import Excel (T-O-V)</h3>
        <div class="field"><input type="file" id="xls-file" accept=".xlsx"></div>
        <div class="row"><button class="btn" id="xls-load">Naƒç√≠st</button><span class="mini">(*vy≈æaduje p≈ôevod na JSON v n8n)</span></div>
      </div>
      <div class="card">
        <h3>Profily sazeb</h3>
        <div class="row">
          <button class="btn flat" id="set-ref">Pou≈æ√≠t REFERENCE</button>
          <button class="btn flat" id="set-firm">Pou≈æ√≠t FIRM</button>
        </div>
      </div>
      <div class="card">
        <h3>Exportovat lok√°ln√≠ data</h3>
        <div class="row">
          <button class="btn ghost" id="dump-ls">Export LocalStorage</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   KONFIG (zmƒõ≈à si na sv√©)
   ========================= */
const N8N_VALIDATE_URL = 'https://YOUR_N8N_HOST/webhook/validate-pro';   // TODO
const N8N_INTAKE       = 'https://YOUR_N8N_HOST/webhook/intake';          // TODO
const N8N_EXPORT_XLSX  = 'https://YOUR_N8N_HOST/webhook/export-xlsx';     // TODO

/* =========== UI =========== */
const $$ = sel => document.querySelector(sel);
const log = msg => { const li=document.createElement('li'); li.textContent=msg; $$('#log').appendChild(li); $$('#last-action').textContent=new Date().toLocaleString(); };

$('#open-bot','#fab-chat','#bot-close','#open-formwork','#bot-formwork','#open-gantt','#bot-harmonogram','#btn-pro','#pro-close','#btn-admin','#admin-close');

function $(...ids){ ids.forEach(id=>{
  const e = document.querySelector(id);
  if(!e) return;
  if(id==='#open-bot' || id==='#fab-chat') e.onclick=()=> $$('#bot-modal').style.display='flex';
  if(id==='#bot-close') e.onclick=()=> $$('#bot-modal').style.display='none';
  if(id==='#open-formwork' || id==='#bot-formwork') e.onclick=()=> alert('Bednƒõn√≠: otev≈ô√≠t kalkul√°tor (v√Ωpoƒçet plochy, set/tear, n√°jem).');
  if(id==='#open-gantt' || id==='#bot-harmonogram') e.onclick=()=> alert('Harmonogram: otev≈ô√≠t n√°st≈ôel Gantt (WBS, vazby, okna).');
  if(id==='#btn-pro') e.onclick=()=> $$('#pro-modal').style.display='flex';
  if(id==='#pro-close') e.onclick=()=> $$('#pro-modal').style.display='none';
  if(id==='#btn-admin') e.onclick=()=> $$('#admin-modal').style.display='flex';
  if(id==='#admin-close') e.onclick=()=> $$('#admin-modal').style.display='none';
});}

document.getElementById('fab-chat').onclick = ()=> $$('#bot-modal').style.display='flex';

/* Drag & Drop */
const dz = document.getElementById('drop');
dz.ondragover = e=>{ e.preventDefault(); dz.classList.add('drag'); };
dz.ondragleave= ()=> dz.classList.remove('drag');
dz.ondrop = e=>{
  e.preventDefault(); dz.classList.remove('drag');
  document.getElementById('file').files = e.dataTransfer.files;
};

/* Intake: files/URL/ZIP */
document.getElementById('send').onclick = async () => {
  const out = document.getElementById('status');
  const url = document.getElementById('url').value.trim();
  const files = document.getElementById('file').files;
  const fd = new FormData();
  if(url) fd.append('remote_url', url);
  [...files].forEach(f => fd.append('files', f));
  fd.append('project_name', (window.PROJECT_NAME||'Ad hoc'));
  out.textContent = 'Nahr√°v√°m‚Ä¶';
  try{
    const r = await fetch(N8N_INTAKE, { method:'POST', body: fd });
    if(!r.ok){ out.textContent = 'Chyba p≈ôi odesl√°n√≠.'; return; }
    const data = await r.json();
    out.textContent = data.message || 'P≈ôijato. Zahajuji zpracov√°n√≠.';
    log('P≈ôijato: job_id='+(data.job_id||'‚Äî'));
  }catch(e){ out.textContent='Chyba p≈ôipojen√≠.'; }
};

/* PRO: ovƒõ≈ôen√≠ a naƒçten√≠ datov√Ωch sad */
document.getElementById('pro-validate').onclick = async ()=>{
  const email = $$('#pro-email').value.trim();
  const token = $$('#pro-token').value.trim();
  const what  = $$('#pro-what').value;
  const out   = $$('#pro-status');
  if(!email || !token){ out.textContent='Vypl≈àte e-mail i token.'; return; }
  out.textContent='Ovƒõ≈ôuji‚Ä¶';
  try{
    const resp = await fetch(N8N_VALIDATE_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, token, want: what, userAgent: navigator.userAgent })
    });
    if(!resp.ok){ out.textContent = 'Chyba p≈ôipojen√≠ / 403'; return; }
    const data = await resp.json();
    if(!data.allowed){ out.textContent = data.message || 'P≈ô√≠stup zam√≠tnut.'; return; }

    const LS = {
      TOV_URS: 'tov_rules_urs',
      TOV_EXP: 'tov_rules_expert',
      RATES:   'rates_catalog',
      COEFS:   'coef_2019',
      TKP:     'tkp_rules'
    };
    if(data.pro?.rules_urs){ localStorage.setItem(LS.TOV_URS, JSON.stringify(data.pro.rules_urs)); }
    if(data.pro?.rules_expert){ localStorage.setItem(LS.TOV_EXP, JSON.stringify(data.pro.rules_expert)); }
    if(data.pro?.rates){ localStorage.setItem(LS.RATES, JSON.stringify(data.pro.rates)); }
    if(data.pro?.tkp){ localStorage.setItem(LS.TKP, JSON.stringify(data.pro.tkp)); }
    if(data.pro?.coefs){ localStorage.setItem(LS.COEFS, JSON.stringify(data.pro.coefs)); }

    $$('#ds-status').textContent = 'PRO';
    $$('#token-status').textContent = token.slice(0,6)+'‚Ä¶';
    out.textContent = 'PRO aktivov√°no. Datov√© sady nahr√°ny.';
  }catch(e){ out.textContent='V√Ωpadek / neplatn√° odpovƒõƒè.'; }
};

/* Chat mock: jednoduch√° uk√°zka parsov√°n√≠ vstupu */
const chat = $$('#chat'), chatIn=$$('#chat-in');
function pushMsg(text, who='me'){
  const div=document.createElement('div'); div.className='msg '+who; div.textContent=text; chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
}
function preview(items){
  const ul=$$('#preview'); ul.innerHTML='';
  items.forEach(it=>{
    const li=document.createElement('li');
    li.innerHTML = `<b>${it.name}</b> ‚Ä¢ <span class="mini">${it.unit||'‚Äî'}/${it.qty||'‚Äî'}</span><br>
    <span class="tag">T: ${it.t_h ? it.t_h.toFixed(1):'?'} h</span>
    <span class="tag">O: ${it.o_h ? it.o_h.toFixed(1):'?'} h</span>
    <span class="tag">V: ${it.v_kc ? it.v_kc.toFixed(0):'?'} Kƒç</span>`;
    ul.appendChild(li);
  });
}
document.getElementById('chat-send').onclick = ()=>{
  const q=chatIn.value.trim(); if(!q) return;
  pushMsg(q,'me'); chatIn.value='';
  // demo: velmi hrub√Ω rozklad (p≈ô√≠klad)
  let item = {name:'‚Äî', unit:'', qty:0, t_h:0, o_h:0, v_kc:0};
  const m3 = (q.match(/(\d+(?:[.,]\d+)?)\s*m3/i)||[])[1]; if(m3) { item.unit='m3'; item.qty=parseFloat(m3.replace(',','.')); }
  if(/≈°tƒõrk|bal(l|)ast|v√Ωmƒõna/i.test(q)) item.name='V√Ωmƒõna ≈°tƒõrku';
  if(/beton|beton√°≈æ|opƒõra/i.test(q)) item.name='Beton√°≈æ opƒõry';
  // pseudo normy (nahrad√≠ TOV z PRO dat)
  if(item.name==='V√Ωmƒõna ≈°tƒõrku'){ item.t_h = 0.75*item.qty; item.o_h=0.65*item.qty; item.v_kc=0; }
  if(item.name==='Beton√°≈æ opƒõry'){ item.t_h = 1.10*item.qty; item.o_h=0.12*item.qty; item.v_kc=0; }
  pushMsg('Zpracov√°no. N√°hled vpravo.','ai');
  preview([item]);
};

/* Admin mini-funkce */
document.getElementById('json-load').onclick = async ()=>{
  const f=$$('#json-file').files?.[0]; if(!f){ $$('#json-status').textContent='Vyberte soubor.'; return; }
  const txt = await f.text();
  try{
    const data = JSON.parse(txt);
    localStorage.setItem('import_generic', JSON.stringify(data));
    $$('#json-status').textContent='Naƒçteno (localStorage: import_generic).';
  }catch(e){ $$('#json-status').textContent='Chyba JSON.'; }
};
document.getElementById('xls-load').onclick = ()=> alert('Excel naƒçti p≈ôes n8n a vra≈• JSON (import_generic).');

/* Helpers */
function saveFile(name, data){
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download=name; a.click();
}
document.getElementById('dump-ls').onclick = ()=>{
  const dump = {};
  for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); dump[k]=localStorage.getItem(k); }
  saveFile('localStorage_dump.json', JSON.stringify(dump,null,2));
};
document.getElementById('export-json').onclick = ()=>{
  const ul=$$('#preview'); const items=[...ul.querySelectorAll('li')].map(li=>li.textContent.trim());
  saveFile('preview.json', JSON.stringify({items},null,2));
};
document.getElementById('export-xlsx').onclick = async ()=>{
  alert('Export XLSX zajist√≠ n8n webhook (po≈°le JSON, vr√°t√≠ .xlsx). Nastav N8N_EXPORT_XLSX.');
};
</script>
</body>
</html>